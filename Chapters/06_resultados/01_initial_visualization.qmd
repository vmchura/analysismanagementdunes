## Most Abundant Plant Species Analysis

This section visualizes the most abundant plant species across the three regions (Tarragona, Barcelona, and Girona). The chart displays the mean abundance of top plant species based on the Braun-Blanquet scale.
```{r}
#| fig-cap: "Distribution of observations across the three regions"
#| echo: false
#| eval: true
#| output: false
# Load necessary libraries
library(tidyverse)
library(ggplot2)
library(gridExtra) # for arranging multiple plots

# Load global configuration
source("../../R/global_config.R")

# Load data
load("../../data/all_observations_split.RData")
load("../../data/all_land_cover_data.RData")

# --- Vegetation Pattern Analysis ---

# Function to calculate average abundance for each species in a region
# Converting Braun-Blanquet values to their maximum percentage coverage
calculate_avg_abundance <- function(region_data) {
  # Get species columns - exclude "plot" and "id_beach"
  species_cols <- setdiff(names(region_data), c("plot", "id_beach"))
  
  # Create a new dataframe to store the percentage values
  percentage_data <- region_data
  
  # Process each species column individually to avoid the vectorized operation issues
  for (col in species_cols) {
    percentage_data[[col]] <- sapply(region_data[[col]], function(value) {
      if (is.na(value)) return(0)
      
      # Convert based on Braun-Blanquet scale
      if (value == 0) return(0)
      else if (value == 0.1) return(5)
      else if (value == 0.5) return(5)
      else if (value == 1) return(5)
      else if (value == 2) return(25)
      else if (value == 3) return(50)
      else if (value == 4) return(75)
      else if (value == 5) return(100)
      else return(as.numeric(value))
    })
  }
  
  # Calculate mean percentage for each species
  percentage_data %>%
    summarise(across(all_of(species_cols), mean, na.rm = TRUE)) %>%
    pivot_longer(cols = everything(),
                 names_to = "species",
                 values_to = "mean_percentage") %>%
    arrange(desc(mean_percentage))
}

# Calculate average abundance for each region
girona_abundance <- calculate_avg_abundance(beaches_by_region$Girona)
barcelona_abundance <- calculate_avg_abundance(beaches_by_region$Barcelona)
tarragona_abundance <- calculate_avg_abundance(beaches_by_region$Tarragona)

# Get top 10 most abundant species in each region
top_girona <- girona_abundance %>% slice_head(n = 3)
top_barcelona <- barcelona_abundance %>% slice_head(n = 3)
top_tarragona <- tarragona_abundance %>% slice_head(n = 3)

# Get the union of top species from all regions
top_species <- unique(c(top_girona$species,
                         top_barcelona$species,
                         top_tarragona$species))

# Function to prepare data for plotting
prepare_plot_data <- function(abundance_data, region_name, top_species_list) {
  abundance_data %>%
    filter(species %in% top_species_list) %>%
    mutate(region = region_name)
}

# Combine data from all regions
plot_data <- bind_rows(
  prepare_plot_data(girona_abundance, "Girona", top_species),
  prepare_plot_data(barcelona_abundance, "Barcelona", top_species),
  prepare_plot_data(tarragona_abundance, "Tarragona", top_species)
)
```
```{r}
#| label: fig-regional-distribution
#| fig-cap: "Distribution of observations across the three regions"
#| echo: false
#| eval: true
#| output: true
# Order regions according to our standard order
plot_data <- order_provinces(plot_data, column_name = "region")


# Order regions according to our standard order
plot_data <- order_provinces(plot_data, column_name = "region")

# Create a bar plot of top species by region
p <- ggplot(plot_data, aes(x = reorder(species, mean_percentage), y = mean_percentage, fill = region)) +
  # Add species bars
  geom_bar(stat = "identity", position = "dodge") +
  coord_flip() +
  theme_minimal() +
  labs(title = "Mean Coverage of Top Plant Species by Region",
       x = "Species",
       y = "Mean Coverage (%)",
       fill = "Region") +
  theme(legend.position = "top",
        axis.text.y = element_text(size = 8)) +
  # Use our custom province colors
  scale_fill_manual(values = PROVINCE_COLORS)

# Apply the percentage scale from our global config
p <- apply_percentage_scale(p)
p

# Save the plot
ggsave("../../figures/top_species_by_region.png", width = 12, height = 8)

```

## Plant species richness by coastal region

```{r}
#| label: fig-species-richness
#| fig-cap: "Beach-level species richness distribution across the three coastal regions, showing biodiversity variations between beaches in Tarragona, Barcelona, and Girona"
#| echo: false
#| eval: true
#| output: true
# --- Species Richness Analysis ---

# Calculate species richness (number of species present) for each beach
calculate_beach_richness <- function(region_data) {
  # Get species columns - exclude "plot" and "id_beach"
  species_cols <- setdiff(names(region_data), c("plot", "id_beach"))

  # Group by beach and calculate presence of each species across the entire beach
  region_data %>%
    group_by(id_beach) %>%
    summarise(across(all_of(species_cols), ~ max(., na.rm = TRUE) > 0)) %>%
    # Replace -Inf with FALSE (happens when all values were NA and we used max with na.rm=TRUE)
    mutate(across(all_of(species_cols), ~ ifelse(is.infinite(.), FALSE, .))) %>%
    # Calculate richness as sum of species present
    mutate(richness = rowSums(across(all_of(species_cols))))
}

# Calculate richness for each region at the beach level
girona_richness <- calculate_beach_richness(beaches_by_region$Girona) %>%
  mutate(region = "Girona")
barcelona_richness <- calculate_beach_richness(beaches_by_region$Barcelona) %>%
  mutate(region = "Barcelona")
tarragona_richness <- calculate_beach_richness(beaches_by_region$Tarragona) %>%
  mutate(region = "Tarragona")

# Combine richness data
all_richness <- bind_rows(girona_richness, barcelona_richness, tarragona_richness)

# Order regions according to our standard order
all_richness <- order_provinces(all_richness, column_name = "region")

# Create box plot of species richness by region
ggplot(all_richness, aes(x = region, y = richness, fill = region)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Beach-level species richness across coastal regions",
       x = "Region",
       y = "Number of Species Present per Beach") +
  theme(legend.position = "none") +
  # Use our custom province colors
  scale_fill_manual(values = PROVINCE_COLORS)

# Save the plot
ggsave("../../figures/species_richness_by_region.png", width = 8, height = 6)

```

## Land cover richness

```{r}
#| label: fig-land-cover
#| fig-cap: "LandCover"
#| echo: false
#| eval: true
#| output: true
# Function to reshape land cover data for plotting
prepare_land_cover <- function(region_data) {
  region_data %>%
    pivot_longer(
      cols = -id_beach,
      names_to = "cover_type",
      values_to = "percentage"
    ) %>%
    # Extract the distance (50m or 100m) from the column name
    mutate(
      distance = ifelse(grepl("^x50m", cover_type), "50m", "100m"),
      # Clean up the cover type name by removing the distance prefix
      cover_type = gsub("^x(50|100)m_(.+)_percent$", "\\2", cover_type)
    )
}

# Prepare land cover data for all regions
girona_land <- prepare_land_cover(land_cover_data$Girona) %>%
  mutate(region = "Girona")
barcelona_land <- prepare_land_cover(land_cover_data$Barcelona) %>%
  mutate(region = "Barcelona")
tarragona_land <- prepare_land_cover(land_cover_data$Tarragona) %>%
  mutate(region = "Tarragona")

# Combine all land cover data
all_land_cover <- bind_rows(girona_land, barcelona_land, tarragona_land)

# Calculate average land cover percentages for each region and distance
avg_land_cover <- all_land_cover %>%
  group_by(region, distance, cover_type) %>%
  summarise(
    mean_percentage = mean(percentage, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  # Filter out cover types with very low percentages for clarity
  filter(mean_percentage > 1)

# Plot land cover composition at 50m by region
ggplot(avg_land_cover %>% filter(distance == "50m"),
       aes(x = region, y = mean_percentage, fill = cover_type)) +
  geom_bar(stat = "identity", position = "stack") +
  theme_minimal() +
  labs(
    title = "Average Land Cover Composition at 50m by Region",
    x = "Region",
    y = "Percentage (%)",
    fill = "Land Cover Type"
  ) +
  scale_fill_brewer(palette = "Set3") +
  theme(legend.position = "right")

# Save the plot
ggsave("../../figures/land_cover_50m_by_region.png", width = 10, height = 6)

# Plot land cover composition at 100m by region
ggplot(avg_land_cover %>% filter(distance == "100m"),
       aes(x = region, y = mean_percentage, fill = cover_type)) +
  geom_bar(stat = "identity", position = "stack") +
  theme_minimal() +
  labs(
    title = "Average Land Cover Composition at 100m by Region",
    x = "Region",
    y = "Percentage (%)",
    fill = "Land Cover Type"
  ) +
  scale_fill_brewer(palette = "Set3") +
  theme(legend.position = "right")

# Save the plot
ggsave("../../figures/land_cover_100m_by_region.png", width = 10, height = 6)
```