Análisis de la composición de cobertura del suelo a 100m de cada playa.

```{r 06_04_setup, include=FALSE}
# Opciones globales de knitr - controla todos los fragmentos de código
knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  echo = FALSE
)

# Cargar librerías necesarias
library(tidyverse)
library(ggplot2)
library(gridExtra) # para organizar múltiples gráficos
library(RColorBrewer) # para paletas de colores
library(here)
# Cargar configuración global
source(here("R","global_config.R"))

# Cargar datos
load(here("data","all_observations_split.RData"))
load(here("data","all_land_cover_data.RData"))

# Función para reestructurar datos de cobertura del suelo para visualización
prepare_land_cover <- function(region_data) {
  region_data %>%
    pivot_longer(
      cols = -id_beach,
      names_to = "cover_type",
      values_to = "percentage"
    ) %>%
    # Extraer la distancia (50m o 100m) del nombre de la columna
    mutate(
      distance = ifelse(grepl("^x50m", cover_type), "50m", "100m"),
      # Limpiar el nombre del tipo de cobertura eliminando el prefijo de distancia
      cover_type = gsub("^x(50|100)m_(.+)_percent$", "\\2", cover_type)
    )
}

# Preparar datos de cobertura del suelo para todas las regiones
girona_land <- prepare_land_cover(land_cover_data$Girona) %>%
  mutate(region = "Girona")
barcelona_land <- prepare_land_cover(land_cover_data$Barcelona) %>%
  mutate(region = "Barcelona")
tarragona_land <- prepare_land_cover(land_cover_data$Tarragona) %>%
  mutate(region = "Tarragona")

# Combinar todos los datos de cobertura del suelo
all_land_cover <- bind_rows(girona_land, barcelona_land, tarragona_land)

# Ordenar regiones según nuestro orden estándar
all_land_cover <- order_provinces(all_land_cover, column_name = "region")

# Calcular porcentajes promedio de cobertura del suelo para cada región y distancia
avg_land_cover <- all_land_cover %>%
  group_by(region, distance, cover_type) %>%
  summarise(
    mean_percentage = mean(percentage, na.rm = TRUE),
    .groups = "drop"
  )

# Asegurar que las regiones mantengan el orden consistente
avg_land_cover <- order_provinces(avg_land_cover, column_name = "region")

# Traducir tipos de cobertura del suelo para visualización
avg_land_cover <- avg_land_cover %>%
  mutate(cover_type_spanish = translate_labels(cover_type))

# Definir una paleta de colores consistente para tipos de cobertura del suelo
land_cover_colors <- colorRampPalette(brewer.pal(8, "Set3"))(length(unique(avg_land_cover$cover_type_spanish)))
names(land_cover_colors) <- unique(avg_land_cover$cover_type_spanish)
```



```{r}
#| label: fig-cobertura-suelo-100m
#| fig-cap: "Distribución de tipos de cobertura del suelo dentro de 100m de las playas en las tres regiones costeras, mostrando el contexto ambiental más amplio de los ecosistemas dunares"
#| echo: false
#| eval: true
#| output: true
#| fig-pos: "H"
# Graficar composición de cobertura del suelo a 100m por región
ggplot(avg_land_cover %>% filter(distance == "100m"),
       aes(x = region, y = mean_percentage, fill = cover_type_spanish)) +
  geom_bar(stat = "identity", position = "stack") +
  theme_minimal() +
  labs(
    title = "Composición de Cobertura del Suelo\ndentro de 100m de las Playas",
    x = "Región",
    y = "Porcentaje (%)",
    fill = "Tipo de Cobertura del Suelo"
  ) +
  scale_fill_manual(values = land_cover_colors) +
  theme(legend.position = "right",
        plot.title = element_text(hjust = 0.5, size = 12))

# Guardar el gráfico
ggsave(here("figures","land_cover_100m_by_region.png"), width = 10, height = 6)
```

La @fig-cobertura-suelo-100m muestra la composición por región. Tarragona: urbano (60%), matorral (20%). Barcelona: urbano (65%), pastizal (20%). Girona: urbano (40%).

Otros tipos de cobertura representan menos del 15% en cada región.