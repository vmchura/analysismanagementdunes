## Preprocesamiento de Datos {#sec-data-preprocessing}

El conjunto de datos principal consiste en un libro de Excel (`db_species_20250214.xlsx`) que contiene información sobre presencia/abundancia de especies en diferentes parcelas de muestreo, porcentajes de cobertura del suelo en radios de 50m y 100m, y prácticas de gestión para áreas de playa. Los datos están estructurados por región geográfica (provincias de Girona, Barcelona y Tarragona).

```{r}
#| label: load-packages
#| echo: false
#| eval: true
#| output: false
library(tidyverse)
library(readxl)
library(janitor)
```

### Procesamiento del Conjunto de Datos Principal

El conjunto de datos principal se cargó desde la hoja `original_data` del libro de Excel. Se aplicaron las siguientes transformaciones:

```{r}
#| label: load-and-process-main-data
#| echo: false
#| eval: true
#| output: false
# Cargar y limpiar datos principales
main_data <- read_excel("../data/db_species_20250214.xlsx", sheet = "original_data")
main_data <- main_data %>% 
  select(where(~ !all(is.na(.)))) %>%
  janitor::clean_names()

# Conversión de datos de abundancia a numérico
eunis_col_index <- which(grepl("eunis", names(main_data), ignore.case = TRUE))
if(length(eunis_col_index) == 0) {
  eunis_col_index <- ncol(main_data) + 1
} else {
  eunis_col_index <- min(eunis_col_index)
}

for(i in 2:min(ncol(main_data), eunis_col_index - 1)) {
  main_data[[i]] <- as.numeric(as.character(main_data[[i]]))
}

# Reordenar columnas para estructura consistente
species_cols <- setdiff(names(main_data),
                      c("plot", "id_beach", "beach", "id_transect", "id_plot", "transect", "eunis"))
ordered_cols <- c("plot", "id_beach", "beach", "id_transect", "id_plot", "transect", "eunis", species_cols)
main_data <- main_data %>% select(all_of(ordered_cols), everything())

save(main_data, file = "../data/processed_data_clean.RData")
```

### Procesamiento de Datos de Cobertura del Suelo y Gestión

Para cada provincia se procesaron por separado los datos de cobertura del suelo (50m y 100m) y las prácticas de gestión. Los datos se estandarizaron en formato numérico y se validó que los porcentajes de cobertura del suelo sumaran aproximadamente 100%.

```{r}
#| label: process-land-cover-management
#| echo: false
#| eval: true
#| output: false
# Función para procesar datos de cobertura del suelo
process_land_cover <- function(sheet_name) {
  land_cover_data <- read_excel("../data/db_species_20250214.xlsx", sheet = sheet_name) %>%
    janitor::clean_names()
  
  id_col <- grep("^id_beach$|^id_plot$", names(land_cover_data), value = TRUE)[1]
  if(is.na(id_col)) {
    id_col <- grep("id.*beach|beach.*id|id.*plot|plot.*id", names(land_cover_data), value = TRUE)[1]
  }
  
  cols_50m <- grep("^(x)?50m_", names(land_cover_data), value = TRUE)
  cols_100m <- grep("^(x)?100m_", names(land_cover_data), value = TRUE)
  
  distance_cols <- c(cols_50m, cols_100m)
  selected_cols <- c(id_col, distance_cols)
  
  filtered_data <- land_cover_data %>% 
    select(all_of(selected_cols)) %>% 
    distinct()
  
  for(col in distance_cols) {
    filtered_data[[col]] <- as.numeric(filtered_data[[col]])
  }
  filtered_data[[id_col]] <- as.integer(filtered_data[[id_col]])
  
  return(filtered_data)
}

# Función para procesar datos de gestión
process_management <- function(sheet_name) {
  management_data <- read_excel("../data/db_species_20250214.xlsx", sheet = sheet_name) %>%
    janitor::clean_names()
  
  expected_cols <- c("id_plot", "id_beach", "beach",
                    "managed_paths", "rope_fences", "mechanical_cleaning",
                    "surface_area_occupied_by_seasonal_services_and_amenities_on_or_less_than_5_m_from_the_dunes",
                    "surface_area_of_parking_or_other_fixed_services_on_or_less_than_5_m_from_the_dunes",
                    "protection_of_the_system_and_the_immediate_environment",
                    "degree_of_protection_according_to_the_iucn_classification")
  
  actual_cols <- vector("character", length(expected_cols))
  for (i in seq_along(expected_cols)) {
    pattern <- expected_cols[i]
    simple_pattern <- gsub("_", ".*", pattern)
    matches <- grep(simple_pattern, names(management_data), ignore.case = TRUE, value = TRUE)
    if (length(matches) > 0) {
      actual_cols[i] <- matches[1]
    }
  }
  
  actual_cols <- actual_cols[!is.na(actual_cols)]
  if (length(actual_cols) > 0) {
    filtered_data <- management_data %>% select(all_of(actual_cols))
    
    id_plot_col <- grep("id.*plot|plot.*id", names(filtered_data), ignore.case = TRUE, value = TRUE)[1]
    id_beach_col <- grep("id.*beach|beach.*id", names(filtered_data), ignore.case = TRUE, value = TRUE)[1]
    
    if (!is.na(id_plot_col)) {
      filtered_data[[id_plot_col]] <- as.integer(filtered_data[[id_plot_col]])
    }
    if (!is.na(id_beach_col)) {
      filtered_data[[id_beach_col]] <- as.integer(filtered_data[[id_beach_col]])
    }
    
    return(filtered_data)
  }
  return(NULL)
}

# Procesar datos por provincia
provinces <- c("girona", "barcelona", "tarragona")

land_cover_data <- list()
management_data <- list()

for(province in provinces) {
  land_cover_sheet <- paste0(province, "_land cover")
  management_sheet <- paste0(province, "_management")
  
  land_cover_data[[str_to_title(province)]] <- process_land_cover(land_cover_sheet)
  management_data[[str_to_title(province)]] <- process_management(management_sheet)
}

save(land_cover_data, file = "../data/all_land_cover_data.RData")
save(management_data, file = "../data/all_management_data.RData")
```

### Validación de Datos

Se implementó un sistema de validación para asegurar la calidad e integridad de los datos procesados. Los aspectos principales validados incluyeron la verificación de formatos de identificadores, rangos de valores de abundancia de especies (0-5), consistencia de porcentajes de cobertura del suelo, y la presencia de todas las variables de gestión esperadas.

```{r}
#| label: validation-summary
#| echo: false
#| eval: true
#| output: false
# Validación básica de datos principales
if (file.exists("../data/processed_data_clean.RData")) {
  load("../data/processed_data_clean.RData")
  cat("Datos principales: ", nrow(main_data), " observaciones con ", ncol(main_data), " variables\n")
}

if (file.exists("../data/all_land_cover_data.RData")) {
  load("../data/all_land_cover_data.RData")
  cat("Datos de cobertura del suelo procesados para ", length(land_cover_data), " provincias\n")
}

if (file.exists("../data/all_management_data.RData")) {
  load("../data/all_management_data.RData")
  cat("Datos de gestión procesados para ", length(management_data), " provincias\n")
}
```

Los conjuntos de datos procesados se guardaron como archivos RData (`processed_data_clean.RData`, `all_land_cover_data.RData`, `all_management_data.RData`) para facilitar su uso en los análisis posteriores.
